<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Game</title>
<style>
body{
  font-family:Arial;
  text-align:center;
  background:#f5f5f5;
}
img{
  width:300px;
  height:300px;
  object-fit:contain;
  margin:20px;
}
button{
  padding:10px 20px;
  margin:10px;
  font-size:16px;
  cursor:pointer;
}
button.correct{
  background-color:#4CAF50;
  color:white;
}

button.wrong{
  background-color:#f44336;
  color:white;
}

#scoreBoard{
  margin-bottom:10px;
  font-weight:bold;
}
</style>
</head>
<body>

<h2 id="scoreBoard">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏ú‡∏¥‡∏î: 0/5</h2>
<div id="highScoreBox">
  ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <span id="highScore">0</span>
</div>
<img id="image" src="">
<div id="options"></div>

<script>
const name = localStorage.getItem("name");
const password = localStorage.getItem("password");

if(!name || !password){
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
  location.href="login.html";
}

async function loadQuestion(){

  const name = localStorage.getItem("name");

  const res = await fetch(`/api/question/${name}`);
  const data = await res.json();

  console.log("QUESTION DATA:", data);

  // üî• ‡πÄ‡∏ä‡πá‡∏Ñ error ‡∏Å‡πà‡∏≠‡∏ô
  if(data.error){
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà");
    location.href = "menu.html";
    return;
  }

  if(data.gameOver){
    alert("‡πÄ‡∏Å‡∏°‡∏à‡∏ö! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: " + data.finalScore);
    location.href = "menu.html";
    return;
  }

  document.getElementById("image").src = data.image || "";

  document.getElementById("scoreBoard").innerText =
    `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${data.score ?? 0} | ‡∏ú‡∏¥‡∏î: ${data.wrong ?? 0}/5`;
    document.getElementById("highScore").innerText = data.highScore ?? 0;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  if(!data.options || data.options.length === 0){
    optionsDiv.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>";
    return;
  }

  data.options.forEach(option=>{
    const btn = document.createElement("button");
    btn.innerText = option;
    btn.style.display = "block";
    btn.style.margin = "10px auto";

    btn.onclick = ()=> submitAnswer(option, btn);

    optionsDiv.appendChild(btn);
  });
}

async function submitAnswer(answer, buttonElement){

  const name = localStorage.getItem("name");

  const res = await fetch(`/api/answer/${name}`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ answer })
  });

  const data = await res.json();

  const allButtons = document.querySelectorAll("#options button");

  // üî• ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
  allButtons.forEach(btn => btn.disabled = true);

  if(data.correct){

    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å
    buttonElement.classList.add("correct");

  }else{

    // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î
    buttonElement.classList.add("wrong");

    // üî• ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    allButtons.forEach(btn=>{
      if(btn.innerText === data.correctAnswer){
        btn.classList.add("correct");
      }
    });
  }

  // ‚è≥ ‡∏£‡∏≠ 1 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
  setTimeout(()=>{

    if(data.gameOver){
      showRanking(data.finalScore);
      return;
    }

    loadQuestion();

  },1000);

  async function showRanking(finalScore){

  document.body.innerHTML = `
    <h1>‡πÄ‡∏Å‡∏°‡∏à‡∏ö!</h1>
    <h2>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${finalScore}</h2>
    <div id="ranking"></div>
    <br>
    <button onclick="location.href='menu.html'">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  `;

  const res = await fetch("/api/ranking");
  const ranking = await res.json();

  const rankingDiv = document.getElementById("ranking");

  ranking.forEach((player, index) => {

    const box = document.createElement("div");
    box.style.border = "1px solid #ccc";
    box.style.margin = "10px auto";
    box.style.padding = "15px";
    box.style.width = "300px";
    box.style.borderRadius = "10px";
    box.style.background = index === 0 ? "#ffd700" : "#fff";

    box.innerHTML = `
      <strong>#${index + 1}</strong><br>
      ${player.name}<br>
      ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${player.score}
    `;

    rankingDiv.appendChild(box);
  });

  }
}

loadQuestion();

</script>

</body>
</html>